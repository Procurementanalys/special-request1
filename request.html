<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Octobull - Store Request Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* Octobull Theme Colors: Orange (#FF6B35), Blue (#004E89), White (#FFFFFF) */
  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  .animate-slideIn { animation: slideIn 0.5s ease-out; }
  .animate-fadeIn { animation: fadeIn 0.6s ease-out; }
  .animate-bounce-slow { animation: bounce 3s ease-in-out infinite; }
  
  .octobull-gradient-header {
    background: linear-gradient(135deg, #004E89 0%, #1A659E 40%, #FF6B35 80%, #FFA500 100%);
  }
  .octobull-bg {
    background: linear-gradient(to bottom right, #f0f9ff 0%, #ffffff 30%, #fff7ed 70%, #ffffff 100%);
  }
  .card-shadow {
    box-shadow: 0 15px 50px rgba(0, 78, 137, 0.15);
  }
  .card-hover:hover {
    transform: translateY(-5px);
    box-shadow: 0 25px 60px rgba(255, 107, 53, 0.25);
    transition: all 0.4s ease;
  }
  input:focus, button:focus { outline: none; }
  
  .octobull-btn-primary {
    background: linear-gradient(135deg, #FF8C42 0%, #FF6B35 100%);
  }
  .octobull-btn-primary:hover {
    background: linear-gradient(135deg, #FF6B35 0%, #F94144 100%);
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(255, 107, 53, 0.5);
  }
  .octobull-btn-secondary {
    background: linear-gradient(135deg, #1A659E 0%, #004E89 100%);
  }
  .octobull-btn-secondary:hover {
    background: linear-gradient(135deg, #004E89 0%, #003566 100%);
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(0, 78, 137, 0.5);
  }
  .octobull-btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  }
  .octobull-btn-success:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(16, 185, 129, 0.5);
  }
  
  .badge-pending { 
    background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%); 
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .badge-approved { 
    background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .badge-rejected { 
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .table-header {
    background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
    color: #004E89;
    font-weight: 700;
  }
  .octobull-border {
    border: 3px solid #e0f2fe;
  }
  .octobull-input {
    border: 2px solid #e0f2fe;
    transition: all 0.3s ease;
  }
  .octobull-input:focus {
    border-color: #FF6B35;
    ring-color: rgba(255, 107, 53, 0.3);
    transform: scale(1.01);
  }
  .octobull-logo-text {
    font-family: 'Arial Black', sans-serif;
    font-weight: 900;
    background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .icon-box {
    background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%);
  }
  .icon-box-blue {
    background: linear-gradient(135deg, #1A659E 0%, #004E89 100%);
  }
</style>
</head>
<body class="octobull-bg min-h-screen">

<!-- Header -->
<div class="octobull-gradient-header text-white px-6 py-6 shadow-2xl">
  <div class="max-w-5xl mx-auto flex justify-between items-center">
    <div class="flex items-center gap-4">
      <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-sm shadow-xl animate-bounce-slow">
        <i class="fas fa-box-open text-3xl"></i>
      </div>
      <div>
        <h1 class="text-3xl font-black tracking-wide">OCTOBULL</h1>
        <h2 class="text-xl font-bold">Form Request Barang</h2>
        <p class="text-sm text-white/90 font-medium">Procurement Management System</p>
      </div>
    </div>
    <button onclick="logout()" class="flex items-center gap-3 bg-white/20 hover:bg-white/30 px-6 py-3 rounded-2xl transition-all backdrop-blur-sm shadow-lg hover:shadow-xl font-bold">
      <i class="fas fa-sign-out-alt text-xl"></i>
      <span>Logout</span>
    </button>
  </div>
</div>

<div class="max-w-5xl mx-auto py-10 px-4">
  
  <!-- Form Tambah Item -->
  <div class="bg-white shadow-2xl rounded-3xl p-10 mb-10 card-shadow animate-slideIn card-hover octobull-border">
    <div class="flex items-center gap-4 mb-8">
      <div class="w-14 h-14 icon-box rounded-2xl flex items-center justify-center shadow-lg">
        <i class="fas fa-plus text-white text-2xl"></i>
      </div>
      <div>
        <h3 class="text-2xl font-black text-gray-800">Tambah Item Request</h3>
        <p class="text-sm text-gray-600 font-medium">Pilih item dan isi detail permintaan</p>
      </div>
    </div>
    
    <div class="grid grid-cols-5 gap-5 items-end mb-8">
      <div class="col-span-2 relative">
        <label class="block text-sm font-bold text-gray-700 mb-3">
          <i class="fas fa-search text-blue-600 mr-1"></i> Cari Item
        </label>
        <input type="text" id="itemSearch" placeholder="Ketik nama item..." 
          class="octobull-input w-full p-4 rounded-2xl focus:ring-4 focus:ring-orange-200 outline-none font-medium shadow-sm" 
          oninput="filterItems(this.value)">
        <div id="itemList" class="absolute bg-white border-2 border-blue-200 rounded-2xl shadow-2xl hidden z-10 w-full max-h-48 overflow-auto mt-2"></div>
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-3">
          <i class="fas fa-hashtag text-orange-600 mr-1"></i> Qty
        </label>
        <input type="number" id="qty" placeholder="0" 
          class="octobull-input w-full p-4 rounded-2xl focus:ring-4 focus:ring-green-200 outline-none font-bold text-center text-lg shadow-sm">
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-3">
          <i class="fas fa-comment text-yellow-600 mr-1"></i> Remarks
        </label>
        <input type="text" id="remarks" placeholder="Catatan..." 
          class="octobull-input w-full p-4 rounded-2xl focus:ring-4 focus:ring-yellow-200 outline-none font-medium shadow-sm">
      </div>
      <button onclick="addItem()" 
        class="octobull-btn-primary text-white rounded-2xl py-4 px-6 font-bold transition-all flex items-center justify-center gap-2 shadow-xl text-base">
        <i class="fas fa-plus-circle text-xl"></i>
        <span>TAMBAH</span>
      </button>
    </div>

    <div class="overflow-x-auto rounded-2xl octobull-border">
      <table id="requestTable" class="w-full">
        <thead class="table-header">
          <tr>
            <th class="px-5 py-4 text-left"><i class="fas fa-box mr-2"></i>Item Name</th>
            <th class="px-5 py-4 text-left"><i class="fas fa-sort-numeric-up mr-2"></i>Quantity</th>
            <th class="px-5 py-4 text-left"><i class="fas fa-comment-dots mr-2"></i>Remarks</th>
            <th class="px-5 py-4 text-center"><i class="fas fa-cog mr-2"></i>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <button onclick="submitRequest()" 
      class="octobull-btn-success mt-8 w-full text-white py-5 rounded-2xl hover:shadow-2xl transition-all font-black text-xl flex items-center justify-center gap-4 shadow-xl">
      <i class="fas fa-paper-plane text-2xl"></i>
      <span>SUBMIT REQUEST</span>
    </button>
    <p id="msg" class="text-center text-base mt-5 font-bold"></p>
  </div>

  <!-- Ticket List -->
  <div class="bg-white shadow-2xl rounded-3xl p-10 card-shadow animate-fadeIn card-hover octobull-border">
    <div class="flex items-center gap-4 mb-8">
      <div class="w-14 h-14 icon-box-blue rounded-2xl flex items-center justify-center shadow-lg">
        <i class="fas fa-ticket-alt text-white text-2xl"></i>
      </div>
      <div>
        <h3 class="text-2xl font-black text-gray-800">Daftar Ticket Saya</h3>
        <p class="text-sm text-gray-600 font-medium">Riwayat permintaan barang</p>
      </div>
    </div>
    <ul id="ticketList" class="space-y-4"></ul>
    <div id="ticketDetail" class="mt-8"></div>
  </div>
</div>

<script>
const BASE_URL = 'https://script.google.com/macros/s/AKfycby9VgDwNbtMeXGLMCG-eTpkAgSomw8JndpDxZ0NPS1NYb-iexn4Vaj1-9aIfAoxV2A9OA/exec';
const store_code = localStorage.getItem("store_code");
if(!store_code) window.location.href="login.html";

let items=[], selectedItems=[];

async function loadItems(){ const res=await fetch(`${BASE_URL}?action=getItems`); items=await res.json(); }
function filterItems(value){
  const list=document.getElementById("itemList");
  list.innerHTML="";
  if(!value) return list.classList.add("hidden");
  const filtered=items.filter(it=>it.item_name.toLowerCase().includes(value.toLowerCase()));
  filtered.slice(0,5).forEach(it=>{
    const div=document.createElement("div");
    div.innerHTML=`<i class="fas fa-cube text-orange-500 mr-2"></i><span class="font-semibold">${it.item_id}</span> - ${it.item_name}`;
    div.className="p-4 hover:bg-blue-50 cursor-pointer transition-colors border-b last:border-b-0 font-medium";
    div.onclick=()=>selectItem(it);
    list.appendChild(div);
  });
  list.classList.remove("hidden");
}
function selectItem(it){
  document.getElementById("itemSearch").value=it.item_name;
  document.getElementById("itemSearch").dataset.itemId=it.item_id;
  document.getElementById("itemList").classList.add("hidden");
}
function addItem(){
  const item_name=document.getElementById("itemSearch").value;
  const item_id=document.getElementById("itemSearch").dataset.itemId;
  const qty=document.getElementById("qty").value;
  const remarks=document.getElementById("remarks").value;
  if(!item_id||!qty)return alert("⚠️ Pilih item dan isi qty!");
  selectedItems.push({item_id,item_name,qty,remarks});
  renderTable();
  document.getElementById("itemSearch").value="";
  document.getElementById("qty").value="";
  document.getElementById("remarks").value="";
}
function renderTable(){
  const tbody=document.querySelector("#requestTable tbody");
  tbody.innerHTML="";
  selectedItems.forEach((it,idx)=>{
    tbody.innerHTML+=`<tr class="border-b hover:bg-orange-50 transition-colors">
      <td class="px-5 py-4 font-semibold text-gray-800">${it.item_name}</td>
      <td class="px-5 py-4 font-black text-orange-600 text-lg">${it.qty}</td>
      <td class="px-5 py-4 text-gray-700">${it.remarks}</td>
      <td class="px-5 py-4 text-center">
        <button onclick="removeItem(${idx})" class="text-red-600 hover:text-white hover:bg-red-600 px-4 py-2 rounded-xl transition-all font-bold shadow-sm hover:shadow-md">
          <i class="fas fa-trash-alt mr-1"></i>Hapus
        </button>
      </td>
    </tr>`;
  });
}
function removeItem(i){selectedItems.splice(i,1);renderTable();}
async function submitRequest(){
  if(selectedItems.length===0)return alert("⚠️ Tambahkan minimal satu item!");
  const msg=document.getElementById("msg");
  msg.innerText="⏳ Mengirim request...";
  msg.className="text-center text-base mt-5 font-bold text-blue-600";
  const res=await fetch(`${BASE_URL}?action=submitRequest&store_code=${store_code}&items=${encodeURIComponent(JSON.stringify(selectedItems))}`);
  const data=await res.json();
  if(data.success){
    msg.innerText=`✅ Berhasil dikirim! Ticket ID: ${data.ticket_id}`;
    msg.className="text-center text-base mt-5 font-bold text-green-600";
    selectedItems=[];
    renderTable();
    loadTickets();
  } else {
    msg.innerText="❌ Gagal submit request.";
    msg.className="text-center text-base mt-5 font-bold text-red-600";
  }
}
async function loadTickets(){
  const res=await fetch(`${BASE_URL}?action=getRequests&store_code=${store_code}`);
  const data=await res.json();
  const ticketList=document.getElementById("ticketList");
  ticketList.innerHTML="";
  const uniqueTickets=[...new Set(data.map(r=>r.ticket_id))];
  uniqueTickets.forEach(t=>{
    const ticketData=data.filter(r=>r.ticket_id===t);
    const status=ticketData[0].status||"Pending";
    const div=document.createElement("div");
    div.className="p-6 bg-gradient-to-r from-blue-50 via-white to-orange-50 border-3 border-blue-200 rounded-2xl hover:border-orange-400 hover:shadow-2xl cursor-pointer transition-all";
    div.innerHTML=`<div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
            <i class="fas fa-ticket-alt text-white text-xl"></i>
          </div>
          <div>
            <span class="font-black text-gray-800 text-lg">Ticket #${t}</span>
            <p class="text-xs text-gray-600 font-medium">${ticketData.length} item(s)</p>
          </div>
        </div>
        <span class="${status==='Approved'?'badge-approved':status==='Rejected'?'badge-rejected':'badge-pending'}">${status}</span>
      </div>`;
    div.onclick=()=>showTicketDetail(t,ticketData);
    ticketList.appendChild(div);
  });
}
function showTicketDetail(id,items){
  let html=`<div class='p-8 bg-gradient-to-br from-blue-50 via-white to-orange-50 border-3 border-blue-300 rounded-3xl shadow-2xl'>
    <h4 class='font-black mb-6 text-2xl text-gray-800 flex items-center gap-3'>
      <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-500 rounded-xl flex items-center justify-center">
        <i class="fas fa-clipboard-list text-white"></i>
      </div>
      Detail Ticket #${id}
    </h4>
    <div class="overflow-x-auto rounded-2xl border-3 border-blue-200">
      <table class='w-full text-sm'>
        <thead class="table-header">
          <tr>
            <th class="px-4 py-3 text-left"><i class="fas fa-box mr-2"></i>Item</th>
            <th class="px-4 py-3 text-left"><i class="fas fa-hashtag mr-2"></i>Qty</th>
            <th class="px-4 py-3 text-left"><i class="fas fa-comment-dots mr-2"></i>Remarks</th>
            <th class="px-4 py-3 text-left"><i class="fas fa-info-circle mr-2"></i>Status</th>
            <th class="px-4 py-3 text-left"><i class="fas fa-comment mr-2"></i>Feedback</th>
          </tr>
        </thead>
        <tbody class="bg-white">
          ${items.map(r=>`<tr class='border-b hover:bg-blue-50'>
            <td class="px-4 py-3 font-semibold text-gray-800">${r.item_name}</td>
            <td class="px-4 py-3 font-black text-orange-600 text-base">${r.qty}</td>
            <td class="px-4 py-3 text-gray-700">${r.remarks}</td>
            <td class="px-4 py-3"><span class="${
              r.status==='Approved'?'badge-approved':r.status==='Rejected'?'badge-rejected':'badge-pending'
            }">${r.status}</span></td>
            <td class="px-4 py-3 text-gray-700 font-medium">${r.feedback || '-'}</td>
          </tr>`).join("")}
        </tbody>
      </table>
    </div>
  </div>`;
  document.getElementById("ticketDetail").innerHTML=html;
}
function logout(){localStorage.clear();window.location.href="login.html";}
loadItems(); loadTickets();
</script>
</body>
</html>
