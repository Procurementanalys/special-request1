<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Store Request Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');
  
  * {
    font-family: 'Poppins', sans-serif;
  }
  
  /* Octobull Theme Colors */
  :root {
    --octobull-orange: #FF6B35;
    --octobull-blue: #004E89;
    --octobull-light-blue: #1A759F;
    --octobull-white: #FFFFFF;
    --octobull-light: #F7F9FC;
  }
  
  /* Loading Animation */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--octobull-blue) 0%, var(--octobull-light-blue) 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    transition: opacity 0.5s ease-out;
  }
  
  .loading-overlay.fade-out {
    opacity: 0;
    pointer-events: none;
  }
  
  .octobull-loader {
    position: relative;
    width: 120px;
    height: 120px;
  }
  
  .octobull-circle {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 4px solid transparent;
    border-top-color: var(--octobull-orange);
    animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
  }
  
  .octobull-circle:nth-child(2) {
    border-top-color: var(--octobull-white);
    animation-delay: -0.3s;
    width: 80%;
    height: 80%;
    top: 10%;
    left: 10%;
  }
  
  .octobull-circle:nth-child(3) {
    border-top-color: var(--octobull-orange);
    animation-delay: -0.6s;
    width: 60%;
    height: 60%;
    top: 20%;
    left: 20%;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .loading-text {
    color: white;
    font-size: 1.2rem;
    font-weight: 600;
    margin-top: 140px;
    animation: pulse 1.5s ease-in-out infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  /* Animations */
  @keyframes slideIn { 
    from { opacity: 0; transform: translateX(-20px); } 
    to { opacity: 1; transform: translateX(0); } 
  }
  
  @keyframes fadeIn { 
    from { opacity: 0; transform: translateY(20px); } 
    to { opacity: 1; transform: translateY(0); } 
  }
  
  .animate-slideIn { animation: slideIn 0.6s ease-out; }
  .animate-fadeIn { animation: fadeIn 0.6s ease-out; }
  
  /* Header Style */
  .octobull-header {
    background: linear-gradient(135deg, var(--octobull-blue) 0%, var(--octobull-light-blue) 100%);
    box-shadow: 0 6px 30px rgba(0, 78, 137, 0.3);
  }
  
  .octobull-logo-header {
    width: 55px;
    height: 55px;
    background: linear-gradient(135deg, var(--octobull-orange) 0%, #FF8C5A 100%);
    box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
  }
  
  /* Card Styles */
  .octobull-card {
    background: white;
    box-shadow: 0 15px 50px rgba(0, 78, 137, 0.15);
    border: 2px solid rgba(255, 107, 53, 0.1);
    transition: all 0.4s ease;
  }
  
  .octobull-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 25px 60px rgba(0, 78, 137, 0.2);
  }
  
  /* Button Styles */
  .btn-octobull-orange {
    background: linear-gradient(135deg, var(--octobull-orange) 0%, #FF8C5A 100%);
    box-shadow: 0 6px 20px rgba(255, 107, 53, 0.3);
    transition: all 0.3s ease;
  }
  
  .btn-octobull-orange:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
  }
  
  .btn-octobull-blue {
    background: linear-gradient(135deg, var(--octobull-blue) 0%, var(--octobull-light-blue) 100%);
    box-shadow: 0 6px 20px rgba(0, 78, 137, 0.3);
    transition: all 0.3s ease;
  }
  
  .btn-octobull-blue:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(0, 78, 137, 0.4);
  }
  
  .btn-octobull-green {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    transition: all 0.3s ease;
  }
  
  .btn-octobull-green:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(16, 185, 129, 0.4);
  }
  
  /* Input Styles */
  input, select {
    border: 2px solid #E5E7EB;
    transition: all 0.3s ease;
  }
  
  input:focus, select:focus {
    border-color: var(--octobull-orange);
    box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
    outline: none;
    transform: scale(1.02);
  }
  
  /* Table Styles */
  .octobull-table-header {
    background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
  }
  
  .octobull-table tbody tr:hover {
    background: linear-gradient(90deg, rgba(255, 107, 53, 0.05) 0%, rgba(0, 78, 137, 0.05) 100%);
  }
  
  /* Badge Styles */
  .badge-pending {
    background: linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%);
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.75rem;
    box-shadow: 0 4px 10px rgba(251, 191, 36, 0.3);
  }
  
  .badge-approved {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.75rem;
    box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
  }
  
  .badge-rejected {
    background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.75rem;
    box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
  }
  
  /* Item List Dropdown */
  #itemList {
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.98);
  }
  
  #itemList div:hover {
    background: linear-gradient(90deg, rgba(255, 107, 53, 0.1) 0%, rgba(0, 78, 137, 0.1) 100%);
  }
  
  /* Ticket Card */
  .ticket-card {
    background: linear-gradient(135deg, rgba(255, 107, 53, 0.05) 0%, rgba(0, 78, 137, 0.05) 100%);
    border: 2px solid rgba(255, 107, 53, 0.2);
    transition: all 0.3s ease;
  }
  
  .ticket-card:hover {
    border-color: var(--octobull-orange);
    transform: translateX(5px);
    box-shadow: 0 8px 25px rgba(255, 107, 53, 0.2);
  }
</style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div style="text-align: center;">
    <div class="octobull-loader">
      <div class="octobull-circle"></div>
      <div class="octobull-circle"></div>
      <div class="octobull-circle"></div>
    </div>
    <div class="loading-text">Loading Request System...</div>
  </div>
</div>

<!-- HEADER -->
<div class="octobull-header text-white px-6 py-6 shadow-xl">
  <div class="max-w-4xl mx-auto flex justify-between items-center">
    <div class="flex items-center gap-4">
      <div class="octobull-logo-header rounded-2xl flex items-center justify-center backdrop-blur-sm">
        <i class="fas fa-box-open text-3xl"></i>
      </div>
      <div>
        <h2 class="text-3xl font-bold">Octobull Request</h2>
        <p class="text-base text-white opacity-90 font-medium">Procurement Management System</p>
      </div>
    </div>
    <button onclick="logout()" 
      class="flex items-center gap-3 bg-white/20 hover:bg-white/30 px-5 py-3 rounded-xl transition-all backdrop-blur-sm font-bold">
      <i class="fas fa-sign-out-alt"></i>
      <span>Logout</span>
    </button>
  </div>
</div>

<div class="max-w-4xl mx-auto py-8 px-4">
  <!-- FORM REQUEST -->
  <div class="octobull-card rounded-3xl p-8 mb-8 animate-slideIn">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg">
        <i class="fas fa-plus text-white text-xl"></i>
      </div>
      <h3 class="text-2xl font-bold" style="color: var(--octobull-blue);">Tambah Item Request</h3>
    </div>

    <div class="grid grid-cols-5 gap-4 items-end mb-6">
      <div class="col-span-2 relative">
        <label class="block text-sm font-bold mb-2" style="color: var(--octobull-blue);">
          <i class="fas fa-search" style="color: var(--octobull-orange);"></i> Cari Item
        </label>
        <input type="text" id="itemSearch" placeholder="Ketik untuk mencari..." 
          class="w-full p-4 rounded-xl font-medium" 
          oninput="filterItems(this.value)">
        <div id="itemList" class="absolute border-2 rounded-xl shadow-2xl hidden z-10 w-full max-h-40 overflow-auto mt-2"></div>
      </div>
      <div>
        <label class="block text-sm font-bold mb-2" style="color: var(--octobull-blue);">
          <i class="fas fa-hashtag" style="color: var(--octobull-orange);"></i> Qty
        </label>
        <input type="number" id="qty" placeholder="0" 
          class="w-full p-4 rounded-xl font-bold text-center">
      </div>
      <div>
        <label class="block text-sm font-bold mb-2" style="color: var(--octobull-blue);">
          <i class="fas fa-comment" style="color: var(--octobull-orange);"></i> Remarks
        </label>
        <input type="text" id="remarks" placeholder="Catatan..." 
          class="w-full p-4 rounded-xl font-medium">
      </div>
      <button onclick="addItem()" 
        class="btn-octobull-orange text-white rounded-xl py-4 px-6 font-bold flex items-center justify-center gap-2">
        <i class="fas fa-plus-circle"></i><span>Tambah</span>
      </button>
    </div>

    <div class="overflow-x-auto rounded-xl border-2 shadow-lg" style="border-color: rgba(255, 107, 53, 0.2);">
      <table id="requestTable" class="w-full">
        <thead class="octobull-table-header">
          <tr>
            <th class="px-5 py-4 text-left font-bold" style="color: var(--octobull-blue);">Item</th>
            <th class="px-5 py-4 text-left font-bold" style="color: var(--octobull-blue);">Qty</th>
            <th class="px-5 py-4 text-left font-bold" style="color: var(--octobull-blue);">Remarks</th>
            <th class="px-5 py-4 text-center font-bold" style="color: var(--octobull-blue);">Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <button id="submitBtn" onclick="submitRequest()" 
      class="btn-octobull-green mt-6 w-full text-white py-5 rounded-xl font-extrabold text-lg flex items-center justify-center gap-3">
      <i class="fas fa-paper-plane"></i><span>Kirim Request</span>
    </button>
    <p id="msg" class="text-center text-sm mt-4 font-bold"></p>
  </div>

  <!-- LIST TICKET -->
  <div class="octobull-card rounded-3xl p-8 animate-fadeIn">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex items-center justify-center shadow-lg">
        <i class="fas fa-ticket-alt text-white text-xl"></i>
      </div>
      <h3 class="text-2xl font-bold" style="color: var(--octobull-blue);">Daftar Ticket Saya</h3>
    </div>
    <ul id="ticketList" class="space-y-4"></ul>
    <div id="ticketDetail" class="mt-6"></div>
  </div>
</div>

<script>
// Hide loading overlay after page load
window.addEventListener('load', function() {
  setTimeout(() => {
    document.getElementById('loadingOverlay').classList.add('fade-out');
  }, 1200);
});

const BASE_URL='https://script.google.com/macros/s/AKfycbwkPR-kE4bLNDg6NxuY53z7W8YgSoXssbKploTjPG9Xj_uLTsUzz6quQuLKBZEdxCP18Q/exec';
const store_code=localStorage.getItem("store_code");
if(!store_code) window.location.href="login.html";
let items=[],selectedItems=[];

async function loadItems(){
  try{
    const res=await fetch(`${BASE_URL}?action=getItems`,{cache:"no-cache"});
    items=await res.json();
  }catch(e){console.error("Gagal load items",e);}
}

function filterItems(v){
  const list=document.getElementById("itemList");
  list.innerHTML="";
  if(!v)return list.classList.add("hidden");
  const filtered=items.filter(it=>it.item_name.toLowerCase().includes(v.toLowerCase()));
  filtered.slice(0,5).forEach(it=>{
    const div=document.createElement("div");
    div.innerHTML=`<i class='fas fa-cube mr-2' style='color: var(--octobull-orange);'></i>${it.item_id} - ${it.item_name}`;
    div.className="p-4 cursor-pointer border-b last:border-b-0 font-medium";
    div.onclick=()=>selectItem(it);
    list.appendChild(div);
  });
  list.classList.remove("hidden");
}

function selectItem(it){
  const input=document.getElementById("itemSearch");
  input.value=it.item_name;
  input.dataset.itemId=it.item_id;
  input.dataset.category=it.category||"";
  document.getElementById("itemList").classList.add("hidden");
}

function addItem(){
  const input=document.getElementById("itemSearch");
  const item_name=input.value;
  const item_id=input.dataset.itemId;
  const category=input.dataset.category||"";
  const qty=document.getElementById("qty").value;
  const remarks=document.getElementById("remarks").value;
  if(!item_id||!qty)return alert("Pilih item dan isi qty!");
  selectedItems.push({item_id,item_name,qty,remarks,category});
  renderTable();
  input.value="";document.getElementById("qty").value="";document.getElementById("remarks").value="";
}

function renderTable(){
  const tbody=document.querySelector("#requestTable tbody");
  tbody.innerHTML="";
  selectedItems.forEach((it,idx)=>{
    tbody.innerHTML+=`<tr class='border-b octobull-table'><td class='px-5 py-4 font-semibold'>${it.item_name}</td><td class='px-5 py-4 font-bold' style='color: var(--octobull-orange);'>${it.qty}</td><td class='px-5 py-4 text-gray-600'>${it.remarks}</td><td class='px-5 py-4 text-center'><button onclick='removeItem(${idx})' class='text-red-500 hover:text-red-700 font-bold'><i class='fas fa-trash mr-2'></i>Hapus</button></td></tr>`;
  });
}

function removeItem(i){selectedItems.splice(i,1);renderTable();}

async function submitRequest(){
  if(selectedItems.length===0)return alert("Tambahkan minimal satu item!");
  const btn=document.getElementById("submitBtn");
  const msg=document.getElementById("msg");
  btn.disabled=true;btn.innerHTML="<i class='fas fa-spinner fa-spin'></i> Mengirim...";
  msg.innerText="";
  try{
    const res=await fetch(BASE_URL,{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:new URLSearchParams({
        action:"submitRequest",
        store_code,
        items:JSON.stringify(selectedItems)
      })
    });
    const data=await res.json();
    if(data.success){
      msg.innerText=`Berhasil dikirim! Ticket ID: ${data.ticket_id}`;
      msg.className="text-center text-sm mt-4 font-bold text-green-600";
      selectedItems=[];renderTable();loadTickets();
    }else throw new Error("submit failed");
  }catch(e){
    console.error(e);
    msg.innerText="Terjadi kesalahan koneksi. Silakan coba lagi.";
    msg.className="text-center text-sm mt-4 font-bold text-red-600";
  }
  btn.disabled=false;btn.innerHTML='<i class="fas fa-paper-plane"></i><span>Kirim Request</span>';
}

async function loadTickets(){
  try{
    const res=await fetch(`${BASE_URL}?action=getRequests&store_code=${store_code}`,{cache:"no-cache"});
    const data=await res.json();
    const ticketList=document.getElementById("ticketList");
    ticketList.innerHTML="";
    const uniqueTickets=[...new Set(data.map(r=>r.ticket_id))];
    uniqueTickets.forEach(t=>{
      const tData=data.filter(r=>r.ticket_id===t);
      const st=tData[0].status||"Pending";
      const div=document.createElement("div");
      div.className="ticket-card p-5 rounded-2xl cursor-pointer";
      div.innerHTML=`<div class='flex justify-between items-center'><div class='flex items-center gap-3'><i class='fas fa-ticket-alt text-2xl' style='color: var(--octobull-orange);'></i><span class='font-bold text-lg' style='color: var(--octobull-blue);'>Ticket #${t}</span></div><span class='${st==='Approved'?'badge-approved':st==='Rejected'?'badge-rejected':'badge-pending'}'>${st}</span></div>`;
      div.onclick=()=>showTicketDetail(t,tData);
      ticketList.appendChild(div);
    });
  }catch(e){console.error("loadTickets failed",e);}
}

function showTicketDetail(id,items){
  let html=`<div class='p-6 bg-gradient-to-br from-orange-50 to-blue-50 border-2 rounded-2xl' style='border-color: var(--octobull-orange);'><h4 class='font-bold mb-4 text-xl' style='color: var(--octobull-blue);'><i class='fas fa-clipboard-list mr-2' style='color: var(--octobull-orange);'></i>Detail Ticket #${id}</h4><table class='w-full text-sm'><thead class='octobull-table-header'><tr><th class='p-3 text-left font-bold'>Item</th><th class='p-3 text-left font-bold'>Qty</th><th class='p-3 text-left font-bold'>Remarks</th><th class='p-3 text-left font-bold'>Status</th><th class='p-3 text-left font-bold'>Feedback</th></tr></thead><tbody>${items.map(r=>`<tr class='border-t'><td class='p-3'>${r.item_name}</td><td class='p-3 font-bold' style='color: var(--octobull-orange);'>${r.qty}</td><td class='p-3'>${r.remarks}</td><td class='p-3'><span class='${r.status==='Approved'?'badge-approved':r.status==='Rejected'?'badge-rejected':'badge-pending'}'>${r.status}</span></td><td class='p-3'>${r.feedback||'-'}</td></tr>`).join("")}</tbody></table></div>`;
  document.getElementById("ticketDetail").innerHTML=html;
}

function logout(){localStorage.clear();window.location.href="login.html";}
loadItems();loadTickets();
</script>
</body>
</html>
